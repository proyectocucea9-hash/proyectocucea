{# ==========================================================================
   PÁGINA DE INICIO (INDEX) - 4 FRANJAS
   1. Presentación: 2 columnas (descripción izquierda | carrusel imágenes derecha)
   2. Ubicación: Mapa Google Maps centrado
   3. Carrusel de 3 tarjetas de presupuesto (centro resaltado: scale 1.1, sombra)
   4. Footer: Contacto + redes (en layout)
   Fondo: Parallax (imagen fija al hacer scroll). Admin: botones Editar/Subir.
   ========================================================================== #}

{% extends "base/layout.html" %}
{% block title %}Inicio{% endblock %}

{% block content %}
<!-- Fondo Parallax editable por Admin (variable fondo_url desde BD) -->
<div class="page-background" role="img" aria-label="Fondo institucional CUCEA" style="background-image: url('{{ fondo_url }}');"></div>
{% if current_user.is_authenticated and current_user.es_administrador %}
<a href="{{ url_for('admin_contenido') }}#fondo" class="btn-fondo-editar" title="Cambiar imagen de fondo">Cambiar fondo</a>
{% endif %}

<div class="page-overlay">
    {# =====================================================================
       FRANJA 1 - PRESENTACIÓN (2 columnas)
       Izquierda: Descripción (textos editables por Admin). Derecha: Carrusel.
       Si es Admin: botones "Editar" (textos) y "Editar" / "Subir" (carrusel).
       ===================================================================== #}
    <section class="franja franja--presentacion" id="franja-1">
        <div class="franja__container container">
            <div class="row franja__container--two-cols g-3">
            <div class="franja-1__descripcion col-12 col-md-6">
                {# Título y párrafos desde BD (contenido_franja1) o por defecto #}
                <h1 class="franja-1__title">{{ contenido_franja1.titulo }}</h1>
                <p class="franja-1__subtitle">{{ contenido_franja1.subtitulo }}</p>
                <p class="franja-1__text">{{ contenido_franja1.parrafo1 }}</p>
                <p class="franja-1__text">{{ contenido_franja1.parrafo2 }}</p>
                {% if current_user.is_authenticated and current_user.es_administrador %}
                <a href="{{ url_for('admin_contenido') }}" class="btn btn--secondary btn-sm" title="Editar textos">Editar textos</a>
                {% endif %}
                <a href="{{ url_for('presupuestos_lista') }}" class="btn btn--primary">Ver Presupuestos</a>
            </div>
            <div class="franja-1__carousel col-12 col-md-6">
                <div class="carousel-intro" aria-label="Carrusel de imágenes institucionales">
                    <div class="carousel-intro__track">
                        {% for slide in carousel_slides %}
                        <div class="carousel-intro__slide {{ 'carousel-intro__slide--active' if loop.first else '' }}" data-slide="{{ loop.index0 }}">
                            <img src="{{ slide.imagen_url }}" alt="{{ slide.titulo_alt or 'Imagen institucional' }}">
                        </div>
                        {% endfor %}
                    </div>
                    <div class="carousel-intro__indicators">
                        {% for slide in carousel_slides %}
                        <button class="carousel-intro__dot {{ 'carousel-intro__dot--active' if loop.first else '' }}" data-slide="{{ loop.index0 }}"></button>
                        {% endfor %}
                    </div>
                </div>
                {% if current_user.is_authenticated and current_user.es_administrador %}
                <div class="franja-1__admin-carousel">
                    <a href="{{ url_for('admin_carrusel') }}" class="btn btn--secondary btn-sm">Editar</a>
                    <a href="{{ url_for('admin_carrusel') }}#subir" class="btn btn--primary btn-sm">Subir imagen</a>
                </div>
                {% endif %}
            </div>
            </div>
        </div>
    </section>

    {# =====================================================================
       FRANJA 2 - UBICACIÓN (Mapa Google Maps)
       ===================================================================== #}
    <section class="franja franja--ubicacion" id="franja-2">
        <div class="franja__container franja__container--mapa">
            <h2 class="franja__title">Nuestra Ubicación</h2>
            <p class="franja__subtitle">{{ map_address }}</p>
            <div class="mapa-container">
                <iframe
                    src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3732.7451607433175!2d-103.38259468456889!3d20.70710108619151!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x8428ae4a3fe74e85%3A0x1b5d96e41d202c05!2sCUCEA%20UdeG!5e0!3m2!1ses!2smx!4v1707180000000!5m2!1ses!2smx"
                    width="100%" height="350" style="border:0; border-radius: 12px;"
                    allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade">
                </iframe>
            </div>
        </div>
    </section>

    {# =====================================================================
       FRANJA 3 - CARRUSEL DE 3 TARJETAS (Presupuestos)
       La del centro siempre resaltada (scale 1.1, sombra). Cada tarjeta:
       Imagen, Fecha, Descripción corta, Categoría. Click → Modal detallado.
       Si Admin: botón Editar por tarjeta y "Subir" (nuevo proyecto).
       ===================================================================== #}
    <section class="franja franja--cards" id="franja-3">
        <div class="franja__container">
            <h2 class="franja__title">Proyectos Presupuestarios</h2>
            <p class="franja__subtitle">Consulta transparente de los recursos y su destino</p>

            {% if current_user.is_authenticated and current_user.es_administrador %}
            <div class="franja-3__admin-actions">
                <a href="{{ url_for('presupuesto_nuevo') }}" class="btn btn--primary btn-sm"><i class="fas fa-upload"></i> Subir proyecto</a>
            </div>
            {% endif %}

            <div class="cards-carousel-wrapper cards-carousel-wrapper--three">
                <button class="cards-carousel__arrow cards-carousel__arrow--prev" id="cards-prev" aria-label="Anterior"><i class="fas fa-chevron-left"></i></button>
                <div class="cards-carousel cards-carousel--three" id="cards-carousel">
                    <div class="cards-carousel__track cards-carousel__track--three" id="cards-track">
                        {% if presupuestos %}
                            {% for p in presupuestos %}
                            <div class="card-budget card-budget--in-carousel" data-id="{{ p.id }}" data-index="{{ loop.index0 }}" role="button" tabindex="0">
                                <div class="card-budget__image">
                                    {% if p.imagen_url %}
                                    <img src="{{ p.imagen_url if p.imagen_url.startswith('http') else url_for('static', filename=p.imagen_url) }}" alt="{{ p.concepto }}">
                                    {% else %}
                                    <div class="card-budget__placeholder"><i class="fas fa-image"></i><span>Sin imagen</span></div>
                                    {% endif %}
                                </div>
                                <p class="card-budget__date">{{ p.fecha.strftime('%d/%m/%Y') }}</p>
                                <span class="card-budget__categoria">{{ p.categoria }}</span>
                                <h3 class="card-budget__title">{{ p.concepto }}</h3>
                                {% if p.cantidad_gasto %}<p class="card-budget__gasto">${{ "{:,.0f}".format(p.cantidad_gasto) }}</p>{% endif %}
                                <p class="card-budget__summary">{{ (p.descripcion_corta or p.descripcion)[:80] + ('...' if (p.descripcion_corta or p.descripcion or '')|length > 80 else '') if (p.descripcion_corta or p.descripcion) else 'Sin descripción' }}</p>
                                {% if current_user.is_authenticated and current_user.es_administrador %}
                                <div class="card-budget__actions" onclick="event.stopPropagation();">
                                    <a href="{{ url_for('presupuesto_editar', id=p.id) }}" class="card-budget__edit-link">Editar</a>
                                    <form action="{{ url_for('borrar_presupuesto', id=p.id) }}" method="POST" class="form-inline card-budget__borrar-form" onsubmit="return confirm('¿Eliminar este proyecto?');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn-link btn-link--danger" title="Borrar"><i class="fas fa-trash"></i> Borrar</button>
                                    </form>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="cards-carousel__empty">
                                <p>No hay proyectos para mostrar.</p>
                                <a href="{{ url_for('presupuestos_lista') }}" class="btn btn--primary">Ver presupuestos</a>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <button class="cards-carousel__arrow cards-carousel__arrow--next" id="cards-next" aria-label="Siguiente"><i class="fas fa-chevron-right"></i></button>
            </div>

            <div class="franja-3__link">
                <a href="{{ url_for('presupuestos_lista') }}" class="btn btn--secondary">Ver todos los presupuestos</a>
            </div>
        </div>
    </section>
</div>

{# =====================================================================
   MODAL DETALLADO - Tamaño mediano, scroll bloqueado en fondo, scroll interno
   Izquierda: Like/Dislike + caja de comentarios estilo Facebook
   Derecha superior: botón Cerrar. Contenido cargado por API al hacer click en card.
   ===================================================================== #}
<div class="modal fade" id="detalleModal" tabindex="-1" aria-labelledby="detalleModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-md">
        <div class="modal-content modal-content--custom">
            <div class="modal-header modal-header--custom">
                <h5 class="modal-title" id="detalleModalLabel">Detalle del Proyecto</h5>
                <button type="button" class="btn-close btn-close--custom" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body modal-body--scrollable">
                <div id="modal-content-placeholder">
                    <p class="text-muted">Cargando...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    // Pasar datos de presupuestos al JS para el carrusel centrado y el modal
    window.PRESUPUESTOS_IDS = {{ presupuestos|map(attribute='id')|list|tojson if presupuestos else '[]' }};
})();
</script>
<script src="{{ url_for('static', filename='js/index-carousel-modal.js') }}"></script>
{% endblock %}
